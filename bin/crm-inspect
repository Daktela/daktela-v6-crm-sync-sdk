#!/usr/bin/env php
<?php

declare(strict_types=1);

// Find autoloader — works from vendor/bin symlink or direct execution
(static function (): void {
    $candidates = [
        __DIR__ . '/../vendor/autoload.php',       // direct execution
        __DIR__ . '/../../../autoload.php',         // installed as dependency
    ];
    foreach ($candidates as $file) {
        if (is_file($file)) {
            require $file;
            return;
        }
    }
    fwrite(STDERR, "Could not find Composer autoloader. Run 'composer install' first.\n");
    exit(1);
})();

use Daktela\CrmSync\Adapter\CrmAdapterInterface;
use Daktela\CrmSync\Exception\SyncException;

// ── Color helpers ───────────────────────────────────────────────────────

$isTty = function_exists('posix_isatty') && posix_isatty(STDOUT);

function color(string $text, string $code): string
{
    global $isTty;
    return $isTty ? "\033[{$code}m{$text}\033[0m" : $text;
}

function bold(string $text): string { return color($text, '1'); }
function green(string $text): string { return color($text, '32'); }
function red(string $text): string { return color($text, '31'); }
function yellow(string $text): string { return color($text, '33'); }
function dim(string $text): string { return color($text, '2'); }

// ── Argv parsing ────────────────────────────────────────────────────────

function parseArgv(array $argv): array
{
    $command = null;
    $args = [];
    $options = [
        'bootstrap' => null,
        'config' => null,
        'json' => false,
        'limit' => null,
        'help' => false,
    ];

    $i = 1; // skip script name
    $count = count($argv);
    while ($i < $count) {
        $arg = $argv[$i];
        if ($arg === '-b' || $arg === '--bootstrap') {
            $options['bootstrap'] = $argv[++$i] ?? null;
        } elseif ($arg === '-c' || $arg === '--config') {
            $options['config'] = $argv[++$i] ?? null;
        } elseif ($arg === '--json') {
            $options['json'] = true;
        } elseif ($arg === '--limit' && isset($argv[$i + 1])) {
            $options['limit'] = (int) $argv[++$i];
        } elseif ($arg === '-h' || $arg === '--help') {
            $options['help'] = true;
        } elseif (str_starts_with($arg, '-')) {
            fwrite(STDERR, "Unknown option: {$arg}\n");
            exit(1);
        } elseif ($command === null) {
            $command = $arg;
        } else {
            $args[] = $arg;
        }
        $i++;
    }

    return ['command' => $command, 'args' => $args, 'options' => $options];
}

// ── Help ────────────────────────────────────────────────────────────────

function showHelp(): void
{
    $usage = <<<'HELP'
    CRM Inspect — Universal CRM adapter debugging tool

    Usage: bin/crm-inspect <command> [args] [options]

    Commands:
      ping                          Test CRM connectivity
      fields <entity>               Discover available fields from sample records
      list <entity>                 Browse contacts/accounts
      show <entity> <id>            Show a single record by ID
      find <entity> <field> <value> Find a record by field lookup
      search <entity> <query>       Fulltext search across records

    Entity names: contact, account, activity
    (search supports: contact, account)

    Options:
      -b, --bootstrap <path>  Bootstrap PHP file that returns a CrmAdapterInterface
                              (default: CRM_INSPECT_BOOTSTRAP env)
      -c, --config <path>     Config file path, passed to bootstrap as $configPath
                              (default: SYNC_CONFIG_PATH env)
      --limit <n>             Number of records (default: 20)
      --json                  Output as JSON
      -h, --help              Show this help message

    Bootstrap file:
      The bootstrap file must return a CrmAdapterInterface instance.
      The variable $configPath is available in the bootstrap scope.

      Example bootstrap file:

        <?php
        use Daktela\CrmSync\Crm\Raynet\RaynetClient;
        use Daktela\CrmSync\Crm\Raynet\RaynetConfigLoader;
        use Daktela\CrmSync\Crm\Raynet\RaynetCrmAdapter;
        use Psr\Log\NullLogger;

        $config = (new RaynetConfigLoader())->load($configPath);
        $logger = new NullLogger();
        $client = new RaynetClient($config, null, $logger);
        return new RaynetCrmAdapter($client, $config, $logger);

    HELP;
    echo $usage;
}

// ── Bootstrap ───────────────────────────────────────────────────────────

function resolveBootstrapPath(?string $explicit): string
{
    if ($explicit !== null) {
        return $explicit;
    }

    $envPath = getenv('CRM_INSPECT_BOOTSTRAP');
    if ($envPath !== false && $envPath !== '') {
        return $envPath;
    }

    // Try common locations
    $candidates = [
        'config/crm-inspect-bootstrap.php',
        'bootstrap/crm-inspect.php',
    ];
    foreach ($candidates as $candidate) {
        if (is_file($candidate)) {
            return $candidate;
        }
    }

    return ''; // will trigger error below
}

function resolveConfigPath(?string $explicit): ?string
{
    if ($explicit !== null) {
        return $explicit;
    }

    $envPath = getenv('SYNC_CONFIG_PATH');
    if ($envPath !== false && $envPath !== '') {
        return $envPath;
    }

    // Try common locations
    $candidates = [
        'config/sync.yaml',
    ];
    foreach ($candidates as $candidate) {
        if (is_file($candidate)) {
            return $candidate;
        }
    }

    return null;
}

function bootstrap(?string $bootstrapPath, ?string $configPathOption): CrmAdapterInterface
{
    $path = resolveBootstrapPath($bootstrapPath);

    if ($path === '' || !is_file($path)) {
        fwrite(STDERR, red("Bootstrap file not found" . ($path !== '' ? ": {$path}" : '')) . "\n");
        fwrite(STDERR, "Provide a bootstrap file that returns a CrmAdapterInterface:\n");
        fwrite(STDERR, "  bin/crm-inspect --bootstrap path/to/bootstrap.php <command>\n");
        fwrite(STDERR, "  CRM_INSPECT_BOOTSTRAP=path/to/bootstrap.php bin/crm-inspect <command>\n");
        exit(1);
    }

    // $configPath is available in the bootstrap file's scope
    $configPath = resolveConfigPath($configPathOption);

    try {
        $result = require $path;
    } catch (\Throwable $e) {
        fwrite(STDERR, red("Bootstrap failed: " . $e->getMessage()) . "\n");
        exit(1);
    }

    if (!$result instanceof CrmAdapterInterface) {
        fwrite(STDERR, red("Bootstrap file must return a CrmAdapterInterface instance.") . "\n");
        fwrite(STDERR, "Got: " . get_debug_type($result) . "\n");
        exit(1);
    }

    return $result;
}

// ── Entity helpers ──────────────────────────────────────────────────────

function validateEntity(string $entity): void
{
    if (!in_array($entity, ['contact', 'account', 'activity'], true)) {
        fwrite(STDERR, red("Unknown entity: {$entity}") . "\n");
        fwrite(STDERR, "Valid entities: contact, account, activity\n");
        exit(1);
    }
}

function validateIterableEntity(string $entity): void
{
    validateEntity($entity);
    if ($entity === 'activity') {
        fwrite(STDERR, red("The '{$entity}' entity does not support listing or field discovery.") . "\n");
        fwrite(STDERR, "Use 'show activity <id>' to inspect a specific activity.\n");
        exit(1);
    }
}

// ── Output helpers ──────────────────────────────────────────────────────

function outputJson(mixed $data): void
{
    echo json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) . "\n";
}

/** Flatten nested array with dot notation */
function flattenKeys(array $data, string $prefix = ''): array
{
    $keys = [];
    foreach ($data as $key => $value) {
        $fullKey = $prefix !== '' ? $prefix . '.' . $key : (string) $key;
        if (is_array($value) && !array_is_list($value)) {
            $keys = array_merge($keys, flattenKeys($value, $fullKey));
        } else {
            $keys[] = $fullKey;
        }
    }
    return $keys;
}

/** Print a simple key-value table */
function printRecord(array $data, int $indent = 0): void
{
    $pad = str_repeat('  ', $indent);
    $maxKeyLen = 0;
    $flat = [];

    foreach ($data as $key => $value) {
        $keyStr = (string) $key;
        if (strlen($keyStr) > $maxKeyLen) {
            $maxKeyLen = strlen($keyStr);
        }
        $flat[$keyStr] = $value;
    }

    foreach ($flat as $key => $value) {
        $label = str_pad($key, $maxKeyLen);
        $display = formatValue($value);
        echo "{$pad}" . dim($label) . "  {$display}\n";
    }
}

function formatValue(mixed $value): string
{
    if ($value === null) {
        return dim('null');
    }
    if (is_bool($value)) {
        return $value ? green('true') : red('false');
    }
    if (is_array($value)) {
        if ($value === []) {
            return dim('[]');
        }
        return json_encode($value, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    }
    return (string) $value;
}

/** Print a table of records with columns */
function printTable(array $rows, array $columns): void
{
    if ($rows === []) {
        echo dim("  (no records)") . "\n";
        return;
    }

    // Calculate column widths
    $widths = [];
    foreach ($columns as $col) {
        $widths[$col] = strlen($col);
    }
    foreach ($rows as $row) {
        foreach ($columns as $col) {
            $val = (string) ($row[$col] ?? '');
            $len = strlen($val);
            if ($len > 60) {
                $len = 60; // cap display width
            }
            if ($len > $widths[$col]) {
                $widths[$col] = $len;
            }
        }
    }

    // Header
    $header = '';
    $separator = '';
    foreach ($columns as $col) {
        $header .= '  ' . bold(str_pad($col, $widths[$col]));
        $separator .= '  ' . str_repeat('─', $widths[$col]);
    }
    echo $header . "\n";
    echo dim($separator) . "\n";

    // Rows
    foreach ($rows as $row) {
        $line = '';
        foreach ($columns as $col) {
            $val = (string) ($row[$col] ?? '');
            if (strlen($val) > 60) {
                $val = substr($val, 0, 57) . '...';
            }
            $line .= '  ' . str_pad($val, $widths[$col]);
        }
        echo $line . "\n";
    }
}

/** Auto-detect table columns from first record */
function detectColumns(string $entity, array $records): array
{
    if ($records === []) {
        return [];
    }

    // Preferred columns per entity type
    $preferred = match ($entity) {
        'contact' => ['id', 'firstName', 'lastName', 'fullName', 'email'],
        'account' => ['id', 'name', 'email', 'city'],
        default => [],
    };

    // Filter to columns that exist in at least one record
    $columns = [];
    foreach ($preferred as $col) {
        foreach ($records as $record) {
            if (array_key_exists($col, $record)) {
                $columns[] = $col;
                break;
            }
        }
    }

    // Fallback: first 5 keys from the first record
    if ($columns === []) {
        $columns = array_slice(array_keys($records[0]), 0, 5);
    }

    return $columns;
}

// ── Commands ────────────────────────────────────────────────────────────

function cmd_ping(CrmAdapterInterface $adapter, bool $json): void
{
    $start = microtime(true);
    $ok = $adapter->ping();
    $elapsed = round((microtime(true) - $start) * 1000);

    if ($json) {
        outputJson([
            'success' => $ok,
            'response_time_ms' => $elapsed,
        ]);
        return;
    }

    if ($ok) {
        echo green('OK') . "  Connected to CRM\n";
    } else {
        echo red('FAIL') . "  Could not connect to CRM\n";
    }
    echo dim("  Response: ") . "{$elapsed}ms\n";

    if (!$ok) {
        exit(1);
    }
}

function cmd_fields(CrmAdapterInterface $adapter, string $entity, int $limit, bool $json): void
{
    validateIterableEntity($entity);

    $allKeys = [];
    $sampleCount = 0;

    $generator = match ($entity) {
        'contact' => $adapter->iterateContacts(),
        'account' => $adapter->iterateAccounts(),
    };

    try {
        foreach ($generator as $entityObj) {
            $keys = flattenKeys($entityObj->toArray());
            foreach ($keys as $key) {
                $allKeys[$key] = ($allKeys[$key] ?? 0) + 1;
            }
            $sampleCount++;
            if ($sampleCount >= $limit) {
                break;
            }
        }
    } catch (\Throwable $e) {
        fwrite(STDERR, yellow("  Warning: " . $e->getMessage()) . "\n");
    }

    if ($allKeys === []) {
        if ($json) {
            outputJson(['fields' => [], 'sample_count' => 0]);
        } else {
            echo yellow("No records found for entity '{$entity}'.") . "\n";
        }
        return;
    }

    ksort($allKeys);

    if ($json) {
        $fields = [];
        foreach ($allKeys as $key => $count) {
            $fields[] = ['field' => $key, 'occurrences' => $count, 'coverage' => round($count / $sampleCount * 100)];
        }
        outputJson(['fields' => $fields, 'sample_count' => $sampleCount]);
        return;
    }

    echo bold("Fields for '{$entity}'") . dim(" ({$sampleCount} sample records)") . "\n\n";

    foreach ($allKeys as $key => $count) {
        $pct = round($count / $sampleCount * 100);
        $bar = $pct === 100 ? green("{$pct}%") : yellow("{$pct}%");
        echo "  " . str_pad((string) $key, 40) . "  {$bar}" . dim(" ({$count}/{$sampleCount})") . "\n";
    }
}

function cmd_list(CrmAdapterInterface $adapter, string $entity, int $limit, bool $json): void
{
    validateIterableEntity($entity);

    $records = [];
    $count = 0;

    $generator = match ($entity) {
        'contact' => $adapter->iterateContacts(),
        'account' => $adapter->iterateAccounts(),
    };

    try {
        foreach ($generator as $entityObj) {
            $records[] = $entityObj->toArray();
            $count++;
            if ($count >= $limit) {
                break;
            }
        }
    } catch (\Throwable $e) {
        fwrite(STDERR, yellow("  Warning: " . $e->getMessage()) . "\n");
    }

    if ($json) {
        outputJson($records);
        return;
    }

    echo bold("{$entity} list") . dim(" (" . count($records) . " records)") . "\n\n";

    if ($records === []) {
        echo dim("  (no records found)") . "\n";
        return;
    }

    $columns = detectColumns($entity, $records);
    printTable($records, $columns);
}

function cmd_show(CrmAdapterInterface $adapter, string $entity, string $id, bool $json): void
{
    validateEntity($entity);

    $entityObj = match ($entity) {
        'contact' => $adapter->findContact($id),
        'account' => $adapter->findAccount($id),
        'activity' => $adapter->findActivity($id),
    };

    if ($entityObj === null) {
        fwrite(STDERR, red("Record not found: {$entity} #{$id}") . "\n");
        exit(1);
    }

    $data = $entityObj->toArray();

    if ($json) {
        outputJson($data);
    } else {
        echo bold("{$entity} #{$id}") . "\n\n";
        printRecord($data);
    }
}

function cmd_find(CrmAdapterInterface $adapter, string $entity, string $field, string $value, bool $json): void
{
    validateEntity($entity);

    $entityObj = match ($entity) {
        'contact' => $adapter->findContactByLookup($field, $value),
        'account' => $adapter->findAccountByLookup($field, $value),
        'activity' => $adapter->findActivityByLookup($field, $value),
    };

    if ($entityObj === null) {
        if ($json) {
            outputJson(null);
        } else {
            fwrite(STDERR, red("No {$entity} found where {$field} = {$value}") . "\n");
        }
        exit(1);
    }

    $data = $entityObj->toArray();

    if ($json) {
        outputJson($data);
    } else {
        echo bold("{$entity}") . dim(" ({$field} = {$value})") . "\n\n";
        printRecord($data);
    }
}

function cmd_search(CrmAdapterInterface $adapter, string $entity, string $query, int $limit, bool $json): void
{
    validateIterableEntity($entity);

    $records = [];
    $count = 0;

    $generator = match ($entity) {
        'contact' => $adapter->searchContacts($query),
        'account' => $adapter->searchAccounts($query),
    };

    try {
        foreach ($generator as $entityObj) {
            $records[] = $entityObj->toArray();
            $count++;
            if ($count >= $limit) {
                break;
            }
        }
    } catch (\Throwable $e) {
        fwrite(STDERR, yellow("  Warning: " . $e->getMessage()) . "\n");
    }

    if ($json) {
        outputJson($records);
        return;
    }

    echo bold("{$entity} search") . dim(" \"{$query}\" — " . count($records) . " results") . "\n\n";

    if ($records === []) {
        echo dim("  (no results)") . "\n";
        return;
    }

    $columns = detectColumns($entity, $records);
    printTable($records, $columns);
}

// ── Main dispatch ───────────────────────────────────────────────────────

$parsed = parseArgv($argv);
$command = $parsed['command'];
$args = $parsed['args'];
$opts = $parsed['options'];

if ($opts['help'] || $command === null || $command === 'help') {
    showHelp();
    exit(0);
}

$adapter = bootstrap($opts['bootstrap'], $opts['config']);

try {
    match ($command) {
        'ping' => cmd_ping($adapter, $opts['json']),

        'fields' => (function () use ($adapter, $args, $opts) {
            if ($args === []) {
                fwrite(STDERR, red("Usage: crm-inspect fields <entity>") . "\n");
                exit(1);
            }
            cmd_fields($adapter, $args[0], $opts['limit'] ?? 20, $opts['json']);
        })(),

        'list' => (function () use ($adapter, $args, $opts) {
            if ($args === []) {
                fwrite(STDERR, red("Usage: crm-inspect list <entity>") . "\n");
                exit(1);
            }
            cmd_list($adapter, $args[0], $opts['limit'] ?? 20, $opts['json']);
        })(),

        'show' => (function () use ($adapter, $args, $opts) {
            if (count($args) < 2) {
                fwrite(STDERR, red("Usage: crm-inspect show <entity> <id>") . "\n");
                exit(1);
            }
            cmd_show($adapter, $args[0], $args[1], $opts['json']);
        })(),

        'find' => (function () use ($adapter, $args, $opts) {
            if (count($args) < 3) {
                fwrite(STDERR, red("Usage: crm-inspect find <entity> <field> <value>") . "\n");
                exit(1);
            }
            cmd_find($adapter, $args[0], $args[1], $args[2], $opts['json']);
        })(),

        'search' => (function () use ($adapter, $args, $opts) {
            if (count($args) < 2) {
                fwrite(STDERR, red("Usage: crm-inspect search <entity> <query>") . "\n");
                exit(1);
            }
            cmd_search($adapter, $args[0], implode(' ', array_slice($args, 1)), $opts['limit'] ?? 20, $opts['json']);
        })(),

        default => (function () use ($command) {
            fwrite(STDERR, red("Unknown command: {$command}") . "\n");
            fwrite(STDERR, "Run 'crm-inspect --help' for usage.\n");
            exit(1);
        })(),
    };
} catch (SyncException $e) {
    fwrite(STDERR, red("Error: " . $e->getMessage()) . "\n");
    exit(1);
}
